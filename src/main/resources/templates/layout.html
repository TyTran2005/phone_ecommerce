<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	th:fragment="view(title, content)" ng-app="cartApp">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title th:replace="${title}">ShopOnline</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
	<link rel="stylesheet" th:href="@{/css/style.css}" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.min.js"></script>
	<!-- Bao gồm file cart.js -->
	<script src="/js/cart.js"></script>
</head>

<body ng-controller="CartController">

	<!-- Navigation -->
	<nav th:replace="~{menu}"></nav>

	<!-- Main Content -->
	<main class="flex-grow-1">
		<div class="container-fluid mt-4">
			<article th:replace="${content}">CONTENT</article>
		</div>
	</main>

	<div id="chatbot-container">
		<div id="chatbot-toggle" onclick="toggleChat()">
			<i id="chatbot-icon" class="fas fa-comment-dots"></i>
		</div>
		<div id="chatbot-box" style="display: none;">
			<div id="chatbot-messages"></div>
			<div id="chatbot-input-area">
				<input id="chatbot-input" type="text" placeholder="Hỏi gì đi..." />
				<button onclick="sendChat()">Gửi</button>
			</div>
		</div>
	</div>


	<!-- Footer -->
	<footer class="footer mt-5 bg-dark">
		<div class="container py-3">
			<div class="row g-1 border-bottom pb-1">
				<!-- About Column -->
				<div class="col-md-4 text-center text-md-start">
					<h5 class="mb-3 text-white-50 fw-normal">
						<i class="fas fa-shopping-bag me-2"></i>ShopOnline
					</h5>
					<p class="small text-secondary mb-0">
						Chất lượng tạo niềm tin <br>Uy tín dựng thương hiệu
					</p>
				</div>

				<!-- Contact Column -->
				<div class="col-md-4 text-center">
					<h5 class="text-white-50 fw-normal mb-3">Liên hệ</h5>
					<ul class="list-unstyled small">
						<li class="mb-2"><a href="mailto:support@shoponline.com"
								class="text-secondary text-decoration-none"> <i
									class="fas fa-envelope me-2"></i>thety22112005@gmail.com
							</a></li>
						<li><a href="tel:19001234" class="text-secondary text-decoration-none"> <i
									class="fas fa-phone me-2"></i>1900 1234
							</a></li>
					</ul>
				</div>

				<!-- Social Media Column -->
				<div class="col-md-4 text-center text-md-end">
					<h5 class="text-white-50 fw-normal mb-3">Kết nối với chúng tôi</h5>
					<div class="d-flex justify-content-center justify-content-md-end gap-3">
						<a href="https://www.facebook.com/tran.the.ty.2024" target="_blank"
							class="text-secondary text-decoration-none">
							<i class="fab fa-facebook fa-lg"></i>
						</a> <a href="https://www.instagram.com/tytran2005/" target="_blank"
							class="text-secondary text-decoration-none"> <i class="fab fa-instagram fa-lg"></i>
						</a> <a href="https://www.youtube.com/@TranTheTy-A" target="_blank"
							class="text-secondary text-decoration-none"> <i class="fab fa-youtube fa-lg"></i>
						</a> <a href="https://www.tiktok.com/@funnytiktok9089?is_from_webapp=1&sender_device=pc"
							target="_blank" class="text-secondary text-decoration-none">
							<i class="fab fa-tiktok fa-lg"></i>
						</a>
					</div>
				</div>
			</div>

			<!-- Copyright -->
			<div class="pt-1 text-center">
				<p class="small mb-0 text-secondary">
					&copy; 2024 ShopOnline. Bảo lưu mọi quyền <span class="mx-2">|</span>
					<a href="#" class="text-secondary text-decoration-none">Điều
						khoản sử dụng</a> <span class="mx-2">|</span> <a href="#"
						class="text-secondary text-decoration-none">Chính sách bảo mật</a>
				</p>
			</div>
		</div>
	</footer>

	<!-- Scripts -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script>
		// Xử lý animation khi scroll
		document.addEventListener('DOMContentLoaded', function () {
			const observer = new IntersectionObserver((entries) => {
				entries.forEach(entry => {
					if (entry.isIntersecting) {
						entry.target.classList.add('animate__animated', 'animate__fadeInUp');
					}
				});
			}, { threshold: 0.1 });

			document.querySelectorAll('.animate-on-scroll').forEach(el => observer.observe(el));
		});
		// Inside your <script> tags or in a separate JS file
		let conversationHistory = []; // Declare this globally or within the scope of your chatbot functions

		function appendMessage(msg, sender) {
			const div = document.createElement('div');
			div.classList.add('message', sender);
			div.textContent = msg;
			document.getElementById('chatbot-messages').appendChild(div);
			const messages = document.getElementById('chatbot-messages');
			messages.scrollTop = messages.scrollHeight;

			// Add message to history
			conversationHistory.push({ role: sender === 'user' ? 'user' : 'model', text: msg });
		}

		function sendChat() {
			const input = document.getElementById('chatbot-input');
			const msg = input.value;
			if (!msg.trim()) return;
			appendMessage(msg, 'user'); // This already adds to history

			input.value = '';

			const accountId = document.getElementById('accountId').value;

			// Prepare the payload, including the entire conversation history
			const payload = {
				question: msg,
				history: conversationHistory.map(item => ({ role: item.role, parts: [{ text: item.text }] }))
			};

			if (accountId && accountId !== "0") payload.accountId = accountId;

			fetch('/api/chatbot', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(payload)
			})
				.then(res => res.json())
				.then(data => appendMessage(data.answer, 'bot')) // This already adds to history
				.catch(() => appendMessage('Có lỗi xảy ra!', 'bot'));
		}

		function toggleChat() {
			const box = document.getElementById('chatbot-box');
			const icon = document.getElementById('chatbot-icon');
			if (box.style.display === 'none') {
				box.style.display = 'flex';
				icon.classList.remove('fa-comment-dots');
				icon.classList.add('fa-times');
			} else {
				box.style.display = 'none';
				icon.classList.remove('fa-times');
				icon.classList.add('fa-comment-dots');
			}
		}

	</script>

	<input type="hidden" id="accountId" th:value="${session.account != null ? session.account.id : 0}" />
</body>

</html>